version: '3.8'

services:
  # Python ETL Service
  python-etl:
    build:
      context: .
      dockerfile: docker/python-etl/Dockerfile
    # container_name removed to allow scaling
    volumes:
      - ./data:/app/data
      - ./research:/app/research
      - ./evidence:/app/evidence
      - ./scripts:/app/scripts
    environment:
      - PYTHONPATH=/app
      - DATA_DIR=/app/data
    networks:
      - kettler-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  # R Analysis Service
  r-analysis:
    build:
      context: .
      dockerfile: docker/r-analysis/Dockerfile
    # container_name removed to allow scaling
    volumes:
      - ./data:/app/data
      - ./research:/app/research
      - ./evidence:/app/evidence
      - ./scripts:/app/scripts
      - ./outputs:/app/outputs
    environment:
      - R_LIBS=/usr/local/lib/R/site-library
      - DATA_DIR=/app/data
    networks:
      - kettler-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  # Vector Query API Service (Python)
  vector-api:
    build:
      context: .
      dockerfile: docker/python-etl/Dockerfile
    # container_name removed to allow scaling
    command: python scripts/etl/vector_api_server.py
    volumes:
      - ./data:/app/data
      - ./scripts:/app/scripts
    ports:
      - "8000:8000"
    environment:
      - PYTHONPATH=/app
      - DATA_DIR=/app/data
    networks:
      - kettler-network
    restart: unless-stopped
    depends_on:
      - python-etl
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  # R Analysis API Service
  r-api:
    build:
      context: .
      dockerfile: docker/r-analysis/Dockerfile
    # container_name removed to allow scaling
    command: Rscript scripts/api/r_api_server.R
    volumes:
      - ./data:/app/data
      - ./research:/app/research
      - ./scripts:/app/scripts
      - ./outputs:/app/outputs
    ports:
      - "8001:8001"
    environment:
      - R_LIBS=/usr/local/lib/R/site-library
      - DATA_DIR=/app/data
    networks:
      - kettler-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

networks:
  kettler-network:
    driver: bridge

volumes:
  data-volume:
  research-volume:
  evidence-volume:
