services:
  # Python ETL Service - Microservice for data processing
  python-etl:
    build:
      context: .
      dockerfile: docker/python-etl/Dockerfile
    volumes:
      - ./data:/app/data
      - ./research:/app/research
      - ./evidence:/app/evidence
      - ./scripts:/app/scripts
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - DATA_DIR=/app/data
      - SERVICE_NAME=python-etl
      - SERVICE_PORT=8000
      - HF_WRITE_TOKEN=${HF_WRITE_TOKEN}
      - HF_READ_TOKEN=${HF_READ_TOKEN}
    networks:
      - kettler-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  # R Analysis Service - Microservice for R-based analysis
  # Note: Temporarily disabled due to R package installation issues
  # Will be enabled once R dependencies are resolved
  # r-analysis:
  #   build:
  #     context: .
  #     dockerfile: docker/r-analysis/Dockerfile
  #   volumes:
  #     - ./data:/app/data
  #     - ./research:/app/research
  #     - ./evidence:/app/evidence
  #     - ./scripts:/app/scripts
  #     - ./outputs:/app/outputs
  #   environment:
  #     - R_LIBS=/usr/local/lib/R/site-library
  #     - DATA_DIR=/app/data
  #     - SERVICE_NAME=r-analysis
  #     - SERVICE_PORT=8001
  #   networks:
  #     - kettler-network
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "Rscript", "--version"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 40s
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '2'
  #         memory: 4G
  #       reservations:
  #         cpus: '1'
  #         memory: 2G

  # Vector Query API Service - Microservice for vector search
  vector-api:
    build:
      context: .
      dockerfile: docker/python-etl/Dockerfile
    command: python scripts/etl/vector_api_server.py
    volumes:
      - ./data:/app/data
      - ./scripts:/app/scripts
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - DATA_DIR=/app/data
      - SERVICE_NAME=vector-api
      - SERVICE_PORT=8000
      - HF_WRITE_TOKEN=${HF_WRITE_TOKEN}
      - HF_READ_TOKEN=${HF_READ_TOKEN}
      - PYTHON_ETL_SERVICE=python-etl:8000
    networks:
      - kettler-network
    restart: unless-stopped
    depends_on:
      python-etl:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  # R Analysis API Service - Microservice for R API endpoints
  # Note: Temporarily disabled due to R package installation issues
  # Will be enabled once R dependencies are resolved
  # r-api:
  #   build:
  #     context: .
  #     dockerfile: docker/r-analysis/Dockerfile
  #   command: Rscript scripts/api/r_api_server.R
  #   volumes:
  #     - ./data:/app/data
  #     - ./research:/app/research
  #     - ./scripts:/app/scripts
  #     - ./outputs:/app/outputs
  #   ports:
  #     - "8001:8001"
  #   environment:
  #     - R_LIBS=/usr/local/lib/R/site-library
  #     - DATA_DIR=/app/data
  #     - SERVICE_NAME=r-api
  #     - SERVICE_PORT=8001
  #   networks:
  #     - kettler-network
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 40s
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '1'
  #         memory: 2G
  #       reservations:
  #         cpus: '0.5'
  #         memory: 1G

  # Service Discovery / Health Monitor - Microservice for service coordination
  service-discovery:
    build:
      context: .
      dockerfile: docker/python-etl/Dockerfile
    command: python scripts/microservices/service_discovery.py
    volumes:
      - ./scripts:/app/scripts
    ports:
      - "8080:8080"
    environment:
      - PYTHONPATH=/app
      - SERVICE_NAME=service-discovery
      - VECTOR_API_SERVICE=vector-api:8000
      - PYTHON_ETL_SERVICE=python-etl:8000
    networks:
      - kettler-network
    restart: unless-stopped
    depends_on:
      vector-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # API Gateway - Single entry point for all services
  api-gateway:
    build:
      context: .
      dockerfile: docker/python-etl/Dockerfile
    command: python scripts/microservices/api_gateway.py
    volumes:
      - ./scripts:/app/scripts
    ports:
      - "8081:8080"
    environment:
      - PYTHONPATH=/app
      - GATEWAY_PORT=8080
      - VECTOR_API_SERVICE=http://vector-api:8000
      - R_API_SERVICE=http://r-api:8001
      - PYTHON_ETL_SERVICE=http://python-etl:8000
    networks:
      - kettler-network
    restart: unless-stopped
    depends_on:
      - vector-api
      - service-discovery
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Message Queue - Async message processing
  message-queue:
    build:
      context: .
      dockerfile: docker/python-etl/Dockerfile
    command: python scripts/microservices/message_queue.py
    volumes:
      - ./scripts:/app/scripts
    ports:
      - "8082:8082"
    environment:
      - PYTHONPATH=/app
      - MESSAGE_QUEUE_PORT=8082
    networks:
      - kettler-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # Metrics Collector - Collects metrics from all services
  metrics-collector:
    build:
      context: .
      dockerfile: docker/python-etl/Dockerfile
    command: python scripts/microservices/metrics_collector.py
    volumes:
      - ./scripts:/app/scripts
    ports:
      - "8083:8083"
    environment:
      - PYTHONPATH=/app
      - METRICS_COLLECTOR_PORT=8083
      - METRICS_COLLECTION_INTERVAL=30
      - VECTOR_API_SERVICE=http://vector-api:8000
      - SERVICE_DISCOVERY_URL=http://service-discovery:8080
      - API_GATEWAY_URL=http://api-gateway:8080
      - MESSAGE_QUEUE_URL=http://message-queue:8082
    networks:
      - kettler-network
    restart: unless-stopped
    depends_on:
      - service-discovery
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

networks:
  kettler-network:
    driver: bridge
    name: kettler-network

volumes:
  data-volume:
    driver: local
  research-volume:
    driver: local
  evidence-volume:
    driver: local
