{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Kettler Data Analysis Database Schema",
  "description": "Complete schema definition for all datasets with primary keys (PK) and foreign keys (FK)",
  "version": "1.0.0",
  "last_updated": "2025-12-08",

  "tables": {
    "firms": {
      "description": "Real estate firms associated with Caitlin Skidmore as principal broker",
      "primary_key": "firm_license",
      "file": "source/skidmore_all_firms_complete.json",
      "columns": {
        "firm_license": {
          "type": "string",
          "format": "regex",
          "pattern": "^[0-9]{10}$",
          "description": "Primary Key: 10-digit Virginia DPOR license number",
          "required": true,
          "unique": true
        },
        "firm_name": {
          "type": "string",
          "description": "Legal name of the firm",
          "required": true
        },
        "individual_license": {
          "type": ["string", "null"],
          "format": "regex",
          "pattern": "^[0-9]{10}$|^null$",
          "description": "Foreign Key: References individual_licenses.license_number. Null if not applicable.",
          "fk_table": "individual_licenses",
          "fk_column": "license_number"
        },
        "license_type": {
          "type": "string",
          "enum": ["Real Estate Firm License"],
          "description": "Type of license (currently all are Real Estate Firm License)",
          "required": true
        },
        "firm_type": {
          "type": "string",
          "enum": ["Corporation", "LLC - Limited Liability Company", "Solely owned LLC", "LLC", "Limited Partnership", "LP"],
          "description": "Legal entity type",
          "required": true
        },
        "address": {
          "type": "string",
          "description": "Business address of the firm",
          "required": true
        },
        "dba_name": {
          "type": ["string", "null"],
          "description": "Doing Business As name if applicable",
          "required": false
        },
        "initial_cert_date": {
          "type": ["string", "null"],
          "format": "date",
          "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$",
          "description": "Date when the firm license was initially certified (YYYY-MM-DD). Null if not available from DPOR.",
          "required": false
        },
        "expiration_date": {
          "type": "string",
          "format": "date",
          "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$",
          "description": "License expiration date (YYYY-MM-DD)",
          "required": true
        },
        "principal_broker": {
          "type": "string",
          "description": "Name of principal broker (should be SKIDMORE CAITLIN MARIE)",
          "required": true
        },
        "gap_years": {
          "type": ["number", "null"],
          "description": "Years between firm license date and Skidmore's license date (2025-05-30). Negative if firm licensed after Skidmore.",
          "required": false
        },
        "state": {
          "type": "string",
          "pattern": "^[A-Z]{2}$",
          "description": "Two-letter state code where firm is licensed",
          "required": true
        },
        "notes": {
          "type": "string",
          "description": "Additional notes and observations",
          "required": false
        },
        "needs_verification": {
          "type": "boolean",
          "description": "Whether data needs verification (should be false for complete records)",
          "required": true,
          "default": false
        },
        "verification_date": {
          "type": ["string", "null"],
          "format": "date",
          "description": "Date when data was verified via DPOR search (YYYY-MM-DD)",
          "required": false
        }
      },
      "indexes": [
        {"columns": ["firm_name"], "unique": false},
        {"columns": ["state"], "unique": false},
        {"columns": ["principal_broker"], "unique": false},
        {"columns": ["address"], "unique": false}
      ]
    },

    "individual_licenses": {
      "description": "Individual real estate licenses for Caitlin Skidmore across multiple states",
      "primary_key": "license_number",
      "file": "source/skidmore_individual_licenses.json",
      "columns": {
        "license_number": {
          "type": "string",
          "format": "regex",
          "pattern": "^[0-9]{10}$",
          "description": "Primary Key: 10-digit license number",
          "required": true,
          "unique": true
        },
        "name": {
          "type": "string",
          "description": "License holder name (should be SKIDMORE, CAITLIN MARIE)",
          "required": true
        },
        "address": {
          "type": "string",
          "description": "Address associated with the license",
          "required": true
        },
        "license_type": {
          "type": "string",
          "enum": ["Real Estate Individual"],
          "description": "Type of license",
          "required": true
        },
        "board": {
          "type": "string",
          "enum": ["Real Estate Board"],
          "description": "Licensing board",
          "required": true
        },
        "state": {
          "type": "string",
          "pattern": "^[A-Z]{2}$",
          "description": "Two-letter state code (derived from license number prefix or address)",
          "required": false,
          "computed": true
        }
      },
      "indexes": [
        {"columns": ["name"], "unique": false},
        {"columns": ["address"], "unique": false}
      ]
    },

    "str_listings": {
      "description": "Short-term rental listings scraped from various platforms",
      "primary_key": "listing_id",
      "composite_key": ["platform", "property_address", "scraped_date"],
      "files": [
        "scraped/airbnb_listings_john_carlyle.json",
        "scraped/vrbo_listings_john_carlyle.json",
        "scraped/front_website_listings.json",
        "scraped/additional_str_listings.json"
      ],
      "columns": {
        "listing_id": {
          "type": "string",
          "description": "Primary Key: Unique identifier for the listing (platform-specific or generated)",
          "required": true,
          "unique": true
        },
        "platform": {
          "type": "string",
          "enum": ["Airbnb", "VRBO", "Front Website", "Other"],
          "description": "Platform where listing was found",
          "required": true
        },
        "property_address": {
          "type": "string",
          "description": "Address of the property",
          "required": true
        },
        "property_name": {
          "type": ["string", "null"],
          "description": "Name/title of the listing",
          "required": false
        },
        "scraped_date": {
          "type": "string",
          "format": "date",
          "description": "Date when listing was scraped (YYYY-MM-DD)",
          "required": true
        },
        "metadata": {
          "type": "object",
          "description": "Additional metadata from scraping",
          "required": false
        }
      },
      "indexes": [
        {"columns": ["platform"], "unique": false},
        {"columns": ["property_address"], "unique": false},
        {"columns": ["scraped_date"], "unique": false}
      ]
    },

    "analysis_results": {
      "description": "Analysis outputs and quality reports",
      "primary_key": "analysis_id",
      "files": [
        "analysis/data_quality_report.json",
        "analysis/analysis_summary.json"
      ],
      "columns": {
        "analysis_id": {
          "type": "string",
          "description": "Primary Key: Unique identifier for analysis run",
          "required": true,
          "unique": true
        },
        "analysis_type": {
          "type": "string",
          "enum": ["data_quality", "connection_analysis", "validation", "summary"],
          "description": "Type of analysis",
          "required": true
        },
        "analysis_date": {
          "type": "string",
          "format": "date",
          "description": "Date when analysis was run (YYYY-MM-DD)",
          "required": true
        },
        "results": {
          "type": "object",
          "description": "Analysis results (structure varies by analysis_type)",
          "required": true
        }
      },
      "indexes": [
        {"columns": ["analysis_type"], "unique": false},
        {"columns": ["analysis_date"], "unique": false}
      ]
    },

    "firm_connections": {
      "description": "Connections and relationships between firms",
      "primary_key": "connection_id",
      "composite_key": ["firm_license_1", "firm_license_2"],
      "file": "analysis/dpor_skidmore_connections.csv",
      "columns": {
        "connection_id": {
          "type": "string",
          "description": "Primary Key: Unique identifier for connection",
          "required": true,
          "unique": true
        },
        "firm_license_1": {
          "type": "string",
          "format": "regex",
          "pattern": "^[0-9]{10}$",
          "description": "Foreign Key: References firms.firm_license",
          "required": true,
          "fk_table": "firms",
          "fk_column": "firm_license"
        },
        "firm_license_2": {
          "type": "string",
          "format": "regex",
          "pattern": "^[0-9]{10}$",
          "description": "Foreign Key: References firms.firm_license",
          "required": true,
          "fk_table": "firms",
          "fk_column": "firm_license"
        },
        "connection_type": {
          "type": "string",
          "enum": ["same_address", "same_principal_broker", "same_license_date", "other"],
          "description": "Type of connection",
          "required": true
        },
        "connection_strength": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Strength of connection (0-1 scale)",
          "required": false
        }
      },
      "indexes": [
        {"columns": ["firm_license_1"], "unique": false},
        {"columns": ["firm_license_2"], "unique": false},
        {"columns": ["connection_type"], "unique": false}
      ]
    }
  },

  "relationships": [
    {
      "from_table": "firms",
      "from_column": "individual_license",
      "to_table": "individual_licenses",
      "to_column": "license_number",
      "relationship_type": "many_to_one",
      "description": "A firm may reference an individual license (optional)"
    },
    {
      "from_table": "firm_connections",
      "from_column": "firm_license_1",
      "to_table": "firms",
      "to_column": "firm_license",
      "relationship_type": "many_to_one",
      "description": "Connection references first firm"
    },
    {
      "from_table": "firm_connections",
      "from_column": "firm_license_2",
      "to_table": "firms",
      "to_column": "firm_license",
      "relationship_type": "many_to_one",
      "description": "Connection references second firm"
    }
  ],

  "constraints": [
    {
      "name": "firms_principal_broker_check",
      "table": "firms",
      "type": "check",
      "condition": "principal_broker = 'SKIDMORE CAITLIN MARIE'",
      "description": "All firms must have SKIDMORE CAITLIN MARIE as principal broker"
    },
    {
      "name": "firms_expiration_after_initial",
      "table": "firms",
      "type": "check",
      "condition": "expiration_date > initial_cert_date OR initial_cert_date IS NULL",
      "description": "Expiration date must be after initial certification date"
    },
    {
      "name": "individual_licenses_name_check",
      "table": "individual_licenses",
      "type": "check",
      "condition": "name = 'SKIDMORE, CAITLIN MARIE'",
      "description": "All individual licenses must belong to SKIDMORE, CAITLIN MARIE"
    }
  ],

  "data_quality_rules": [
    {
      "table": "firms",
      "rule": "firm_license must be exactly 10 digits",
      "validation": "regex_match(firm_license, '^[0-9]{10}$')"
    },
    {
      "table": "firms",
      "rule": "address cannot be null",
      "validation": "address IS NOT NULL"
    },
    {
      "table": "firms",
      "rule": "expiration_date must be valid date",
      "validation": "is_valid_date(expiration_date)"
    },
    {
      "table": "individual_licenses",
      "rule": "license_number must be exactly 10 digits",
      "validation": "regex_match(license_number, '^[0-9]{10}$')"
    }
  ]
}
