---
title: "DPOR Multi-State License Search Analysis Report"
author: "Kettler Data Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(dplyr)
library(ggplot2)
library(knitr)
library(jsonlite)
```

## Executive Summary

This report analyzes license data from Department of Professional and Occupational Regulation (DPOR) websites across all 50 states, focusing on connections between specified firms and Caitlin Skidmore.

## Data Sources

- Virginia DPOR License Lookup
- State-specific DPOR/licensing websites across all 50 states
- Existing Skidmore firm and individual license data

## Methodology

1. **Data Collection**: Automated searches across 50 state DPOR websites
2. **Data Cleaning**: Standardization using Hugging Face transformers
3. **Connection Analysis**: Identification of relationships through:
   - Principal broker listings
   - Address matching
   - License pattern analysis
4. **Quality Validation**: Duplicate detection and data quality checks

## Results

### Connection Summary

```{r load-connections}
connections_file <- "data/analysis/dpor_skidmore_connections.csv"
if (file.exists(connections_file)) {
  connections <- read.csv(connections_file, stringsAsFactors = FALSE)

  cat("Total Connections Found:", nrow(connections), "\n")
  if (nrow(connections) > 0 && "firm_name" %in% names(connections)) {
    cat("Unique Firms Connected:", length(unique(connections$firm_name)), "\n")
  } else {
    cat("Unique Firms Connected: 0\n")
  }
  if (nrow(connections) > 0 && "state" %in% names(connections)) {
    cat("States with Connections:", length(unique(connections$state)), "\n")
  } else {
    cat("States with Connections: 0\n")
  }
} else {
  cat("Connection data not found. Run analysis scripts first.\n")
}
```

### Connections by Type

```{r connection-types}
if (exists("connections") && nrow(connections) > 0) {
  type_summary <- connections %>%
    group_by(connection_type) %>%
    summarise(count = n(), .groups = 'drop') %>%
    arrange(desc(count))

  kable(type_summary, caption = "Connections by Type")

  # Visualization
  ggplot(type_summary, aes(x = reorder(connection_type, count), y = count)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    coord_flip() +
    labs(title = "Connections by Type", x = "Connection Type", y = "Count") +
    theme_minimal()
} else {
  cat("No connection data available for visualization.\n")
}
```

### Connections by State

```{r connections-by-state}
if (exists("connections") && nrow(connections) > 0) {
  state_summary <- connections %>%
    group_by(state) %>%
    summarise(count = n(), .groups = 'drop') %>%
    arrange(desc(count)) %>%
    head(10)

  kable(state_summary, caption = "Top 10 States by Connection Count")

  # Visualization
  ggplot(state_summary, aes(x = reorder(state, count), y = count)) +
    geom_bar(stat = "identity", fill = "darkgreen") +
    coord_flip() +
    labs(title = "Top 10 States with Connections", x = "State", y = "Connection Count") +
    theme_minimal()
} else {
  cat("No connection data available for visualization.\n")
}
```

### Data Quality Metrics

```{r quality-metrics}
quality_file <- "data/analysis/data_quality_report.json"
if (file.exists(quality_file)) {
  quality_report <- fromJSON(quality_file)

  cat("### Overall Completeness:", round(quality_report$overall_completeness, 2), "%\n\n")

  if (!is.null(quality_report$license_validation)) {
    cat("### License Validation\n")
    cat("- Valid:", quality_report$license_validation$valid, "\n")
    cat("- Invalid:", quality_report$license_validation$invalid, "\n")
    cat("- Missing:", quality_report$license_validation$missing, "\n\n")
  }

  if (!is.null(quality_report$duplicates)) {
    cat("### Duplicate Analysis\n")
    cat("- Total Duplicates:", quality_report$duplicates$total_duplicates, "\n")
    cat("- Duplicate Groups:", quality_report$duplicates$duplicate_groups, "\n")
    cat("- Unique Records:", quality_report$duplicates$unique_records, "\n")
  }
} else {
  cat("Quality report not found. Run validation script first.\n")
}
```

## Key Findings

```{r key-findings}
if (exists("connections") && nrow(connections) > 0) {
  cat("### Top Connected Firms\n\n")
  top_firms <- connections %>%
    group_by(firm_name) %>%
    summarise(connection_count = n(), .groups = 'drop') %>%
    arrange(desc(connection_count)) %>%
    head(10)

  kable(top_firms, caption = "Top 10 Firms by Connection Count")
}
```

## Recommendations

1. **Further Investigation**: Review firms with multiple connection types
2. **Address Clustering**: Analyze firms sharing addresses
3. **Cross-State Patterns**: Identify multi-state licensing patterns
4. **Data Quality**: Address flagged data quality issues

## Appendix

### Data Files Generated

- `dpor_all_firms_results.csv` - All firm search results
- `dpor_skidmore_connections.csv` - Identified connections
- `dpor_multi_state_summary.csv` - Summary by state
- `dpor_validated.csv` - Validated and quality-checked data
- `data_quality_report.json` - Detailed quality metrics

### Technical Details

- **Search Framework**: R (httr, rvest)
- **Data Cleaning**: Python (Hugging Face transformers)
- **Analysis**: R (dplyr, data.table)
- **States Searched**: All 50 states
- **Search Date**: `r Sys.Date()`
